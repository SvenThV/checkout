<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner | ShopEasy</title>
    <link rel="stylesheet" href="styles.css"> <!-- Shared CSS file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
    <header>
        <h1>Barcode Scanner</h1>
    </header>

    <main>
        <section id="scanner-section">
            <div id="scanner-container"></div>
            <p id="output">Scanning...</p>
        </section>
    </main>

    <footer class="footer">
        <a href="index.html" class="icon" aria-label="Home">üè†</a>
        <a href="barcode.html" class="icon" aria-label="Scanner">üîç</a>
        <a href="receipts.html" class="icon" aria-label="Receipts">üìÑ</a>
        <a href="cart.html" class="icon" aria-label="Cart">üì¶</a>
        <a href="account.html" class="icon" aria-label="Account">üë§</a>
    </footer>

    <script>
        let scannedBarcodes = new Set(); // Track scanned barcodes to prevent duplicates

        document.addEventListener("DOMContentLoaded", () => {
            const outputElement = document.getElementById("output");

            // Initialize Quagga.js for barcode scanning
            Quagga.init(
                {
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector("#scanner-container"),
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment", // Use rear camera
                        },
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "upc_reader"], // Supported barcode types
                    },
                },
                (err) => {
                    if (err) {
                        console.error("Error initializing Quagga:", err);
                        outputElement.textContent = "Scanner initialization failed.";
                        return;
                    }
                    console.log("Quagga initialized successfully.");
                    Quagga.start();
                }
            );

            // Debounced barcode detection
            Quagga.onDetected(async (data) => {
                const barcode = data.codeResult.code;

                // Prevent duplicate processing of the same barcode
                if (scannedBarcodes.has(barcode)) return;
                scannedBarcodes.add(barcode);

                console.log("Barcode detected:", barcode);
                outputElement.textContent = `Detected barcode: ${barcode}`;

                // Fetch product details and send to cart backend
                try {
                    const response = await fetch(`http://localhost:5000/api/products/${barcode}`);
                    if (!response.ok) {
                        throw new Error("Product not found");
                    }

                    const product = await response.json();

                    // Send product to cart backend
                    await fetch("http://localhost:5000/api/cart", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(product),
                    });

                    outputElement.textContent = `Added to cart: ${product.product_name}`;
                    console.log("Product added to cart:", product);
                } catch (error) {
                    console.error("Error fetching product:", error);
                    outputElement.innerHTML = `<p>Product not found. Please try again.</p>`;
                }

                // Clear the barcode after 5 seconds to allow scanning again
                setTimeout(() => scannedBarcodes.delete(barcode), 5000);
            });
        });
    </script>
</body>
</html>